import { randomUUID } from "crypto";
// pseudocode implementation of this file is located in another gist
import { createInvoiceInDatabase, createPaymentInDatabase, getInvoiceFromDatabase } from "../database"; 

bot.command("invoice", async (ctx) => {
  sendInvoice(ctx, ctx.from.id);
});

bot.on("pre_checkout_query", async (ctx) => {
  onPreCheckout(ctx);
});

bot.on("successful_payment", async (ctx) => {
  onSuccesssfullPayment(ctx)
});

function onPreCheckout(ctx) {
  const { id, invoice_payload } = ctx.preCheckoutQuery;
  // here you can check if this invoice can be fulfilled
  const invoice = await getInvoiceFromDatabase(invoice_payload); 
  try {
    await ctx.telegram.answerPreCheckoutQuery(id, true);
  } catch (e) {
    // handle error
    throw e;
  }
}

function onSuccesssfullPayment(ctx) {
  const successful_payment = ctx.update.message.successful_payment;
  const { total_amount, invoice_payload, telegram_payment_charge_id } =
    successful_payment;

  const invoice = await getInvoiceFromDatabase(invoice_payload);
 
  await createPaymentInDatabase({
    payment_id: telegram_payment_charge_id,
    user_id: ctx.from!.id,
    amount: total_amount,
    invoice_id: invoice?.id,
  });
  await sendMessage(ctx, ctx.from!.id, "Yay, you have paid for the service!");
}

export async function sendInvoice(
  telegraf: Context<any>,
  chatId: number
) {
  const amount = 100; // amount of stars you want to charge
  const product = "Premium-version";
  const payload = randomUUID();
  try {
    await telegraf.telegram.sendInvoice(chatId, {
      currency: "XTR", 
      prices: [{ label: product, amount }],
      title: product,
      provider_token: "",
      description: `Fantastic opportunities!`,
      payload,
      photo_url:
        "https://upload.wikimedia.org/wikipedia/en/thumb/5/5f/Original_Doge_meme.jpg/220px-Original_Doge_meme.jpg",
      photo_width: 500,
      photo_height: 500,
      start_parameter: "no_pay",
    });
     
    
    await createInvoiceInDatabase({ amount, product, payload, user_id: chatId });
  } catch (e) {
    // handle error
    throw e;
  }
}
